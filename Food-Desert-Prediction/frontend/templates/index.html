<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Desert Prediction Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .risk-high { background-color: #dc3545; color: white; }
        .risk-moderate { background-color: #ffc107; color: black; }
        .risk-low { background-color: #ff9800; color: white; }
        .risk-very-low { background-color: #28a745; color: white; }
        .probability-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .probability-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .stats-card {
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-map"></i> Food Desert Prediction Dashboard
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Summary Statistics -->
        <div class="row mb-4" id="summary-stats">
            <div class="col-md-3">
                <div class="card stats-card border-danger">
                    <div class="card-body">
                        <h5 class="card-title">High Risk</h5>
                        <h2 id="high-risk-count">-</h2>
                        <small class="text-muted">Tracts at high risk</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card border-warning">
                    <div class="card-body">
                        <h5 class="card-title">Moderate Risk</h5>
                        <h2 id="moderate-risk-count">-</h2>
                        <small class="text-muted">Tracts at moderate risk</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card border-info">
                    <div class="card-body">
                        <h5 class="card-title">Low Risk</h5>
                        <h2 id="low-risk-count">-</h2>
                        <small class="text-muted">Tracts at low risk</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card border-success">
                    <div class="card-body">
                        <h5 class="card-title">Total Tracts</h5>
                        <h2 id="total-tracts">-</h2>
                        <small class="text-muted">Analyzed</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-search"></i> Search Tracts</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">State</label>
                        <input type="text" class="form-control" id="search-state" placeholder="e.g., Texas">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">County</label>
                        <input type="text" class="form-control" id="search-county" placeholder="e.g., Harris">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Risk Level</label>
                        <select class="form-select" id="search-risk">
                            <option value="">All</option>
                            <option value="High Risk">High Risk</option>
                            <option value="Moderate Risk">Moderate Risk</option>
                            <option value="Low Risk (Emerging)">Low Risk (Emerging)</option>
                            <option value="Very Low Risk">Very Low Risk</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">Min Probability</label>
                        <input type="range" class="form-range" id="min-prob" min="0" max="1" step="0.01" value="0">
                        <small id="min-prob-value">0.00</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Max Probability</label>
                        <input type="range" class="form-range" id="max-prob" min="0" max="1" step="0.01" value="1">
                        <small id="max-prob-value">1.00</small>
                    </div>
                </div>
                <button class="btn btn-primary mt-3" onclick="searchTracts()">
                    <i class="bi bi-search"></i> Search
                </button>
            </div>
        </div>

        <!-- Results Table -->
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-table"></i> Results</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="results-table">
                        <thead>
                            <tr>
                                <th>Census Tract</th>
                                <th>State</th>
                                <th>County</th>
                                <th>Risk Level</th>
                                <th>Probability</th>
                                <th>Currently Low Access</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="results-body">
                            <tr>
                                <td colspan="7" class="text-center">Use search to find tracts</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = '{{ api_url }}';

        // Load summary on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSummary();
            setupRangeInputs();
        });

        function setupRangeInputs() {
            const minProb = document.getElementById('min-prob');
            const maxProb = document.getElementById('max-prob');
            const minProbValue = document.getElementById('min-prob-value');
            const maxProbValue = document.getElementById('max-prob-value');

            minProb.addEventListener('input', (e) => {
                minProbValue.textContent = parseFloat(e.target.value).toFixed(2);
            });

            maxProb.addEventListener('input', (e) => {
                maxProbValue.textContent = parseFloat(e.target.value).toFixed(2);
            });
        }

        async function loadSummary() {
            try {
                const response = await fetch(`${API_URL}/summary`);
                const data = await response.json();
                
                document.getElementById('total-tracts').textContent = data.total_tracts.toLocaleString();
                document.getElementById('high-risk-count').textContent = data.high_risk_count.toLocaleString();
                document.getElementById('moderate-risk-count').textContent = data.moderate_risk_count.toLocaleString();
                document.getElementById('low-risk-count').textContent = data.low_risk_count.toLocaleString();
            } catch (error) {
                console.error('Error loading summary:', error);
            }
        }

        async function searchTracts() {
            const state = document.getElementById('search-state').value;
            const county = document.getElementById('search-county').value;
            const riskLevel = document.getElementById('search-risk').value;
            const minProb = document.getElementById('min-prob').value;
            const maxProb = document.getElementById('max-prob').value;

            const params = new URLSearchParams();
            if (state) params.append('state', state);
            if (county) params.append('county', county);
            if (riskLevel) params.append('risk_level', riskLevel);
            if (minProb) params.append('min_probability', minProb);
            if (maxProb) params.append('max_probability', maxProb);
            params.append('limit', '100');

            try {
                const response = await fetch(`${API_URL}/search?${params}`);
                const data = await response.json();
                
                displayResults(data.tracts);
            } catch (error) {
                console.error('Error searching:', error);
                alert('Error searching tracts. Make sure the API is running.');
            }
        }

        function displayResults(tracts) {
            const tbody = document.getElementById('results-body');
            
            if (tracts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No tracts found</td></tr>';
                return;
            }

            tbody.innerHTML = tracts.map(tract => {
                const riskClass = getRiskClass(tract.risk_level);
                const probPercent = (tract.probability * 100).toFixed(1);
                const currentlyLowAccess = tract.currently_low_access === 1 ? 
                    '<span class="badge bg-danger">Yes</span>' : 
                    '<span class="badge bg-success">No</span>';
                
                return `
                    <tr>
                        <td>${tract.CensusTract}</td>
                        <td>${tract.State}</td>
                        <td>${tract.County}</td>
                        <td><span class="badge ${riskClass}">${tract.risk_level}</span></td>
                        <td>
                            <div class="probability-bar">
                                <div class="probability-fill ${riskClass}" style="width: ${probPercent}%"></div>
                            </div>
                            <small>${probPercent}%</small>
                        </td>
                        <td>${currentlyLowAccess}</td>
                        <td>
                            <a href="/tract/${tract.CensusTract}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-info-circle"></i> Details
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getRiskClass(riskLevel) {
            if (riskLevel === 'High Risk') return 'risk-high';
            if (riskLevel === 'Moderate Risk') return 'risk-moderate';
            if (riskLevel === 'Low Risk (Emerging)') return 'risk-low';
            return 'risk-very-low';
        }
    </script>
</body>
</html>

